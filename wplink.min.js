var wpLink;(function(e){var t={},n={},r,i,s;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",append:function(){var t='<br /><label><input type="checkbox" id="nofollow-checkbox" /> <code>rel="nofollow"</code></label>';e("#wp-link .link-target").append(t)},init:function(){t.dialog=e("#wp-link");t.submit=e("#wp-link-submit");t.url=e("#url-field");t.nonce=e("#_ajax_linking_nonce");t.title=e("#link-title-field");t.openInNewTab=e("#link-target-checkbox");t.relNofollow=e("#nofollow-checkbox");t.search=e("#search-field");n.search=new i(e("#search-results"));n.recent=new i(e("#most-recent-results"));n.elements=e(".query-results",t.dialog);t.dialog.keydown(wpLink.keydown);t.dialog.keyup(wpLink.keyup);t.submit.click(function(e){e.preventDefault();wpLink.update()});e("#wp-link-cancel").click(function(e){e.preventDefault();wpLink.close()});e("#internal-toggle").click(wpLink.toggleInternalLinking);n.elements.bind("river-select",wpLink.updateFields);t.search.keyup(wpLink.searchInternalLinks);t.dialog.bind("wpdialogrefresh",wpLink.refresh);t.dialog.bind("wpdialogbeforeopen",wpLink.beforeOpen);t.dialog.bind("wpdialogclose",wpLink.onClose)},beforeOpen:function(){wpLink.range=null;if(!wpLink.isMCE()&&document.selection){wpLink.textarea.focus();wpLink.range=document.selection.createRange()}},open:function(){if(!wpActiveEditor)return;this.textarea=e("#"+wpActiveEditor).get(0);if(!t.dialog.data("wpdialog")){t.dialog.wpdialog({title:wpLinkL10n.title,width:480,height:"auto",modal:true,dialogClass:"wp-dialog",zIndex:3e5})}t.dialog.wpdialog("open")},isMCE:function(){return tinyMCEPopup&&(r=tinyMCEPopup.editor)&&!r.isHidden()},refresh:function(){n.search.refresh();n.recent.refresh();if(wpLink.isMCE())wpLink.mceRefresh();else wpLink.setDefaultValues();t.url.focus()[0].select();if(!n.recent.ul.children().length)n.recent.ajax()},mceRefresh:function(){var e;r=tinyMCEPopup.editor;tinyMCEPopup.restoreSelection();if(e=r.dom.getParent(r.selection.getNode(),"A")){t.url.val(r.dom.getAttrib(e,"href"));t.title.val(r.dom.getAttrib(e,"title"));if("_blank"==r.dom.getAttrib(e,"target"))t.openInNewTab.prop("checked",true);if("nofollow"==r.dom.getAttrib(e,"rel"))t.relNofollow.prop("checked",true);t.submit.val(wpLinkL10n.update)}else{wpLink.setDefaultValues()}tinyMCEPopup.storeSelection()},close:function(){if(wpLink.isMCE())tinyMCEPopup.close();else t.dialog.wpdialog("close")},onClose:function(){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}},getAttrs:function(){return{href:t.url.val(),title:t.title.val(),target:t.openInNewTab.prop("checked")?"_blank":"",rel:t.relNofollow.prop("checked")?"nofollow":""}},update:function(){if(wpLink.isMCE())wpLink.mceUpdate();else wpLink.htmlUpdate()},htmlUpdate:function(){var e,t,n,r,i,s=wpLink.textarea;if(!s)return;e=wpLink.getAttrs();if(!e.href||e.href=="http://")return;t='<a href="'+e.href+'"';if(e.title)t+=' title="'+e.title+'"';if(e.target)t+=' target="'+e.target+'"';if(e.rel)t+=' rel="'+e.rel+'"';t+=">";if(document.selection&&wpLink.range){s.focus();wpLink.range.text=t+wpLink.range.text+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else if(typeof s.selectionStart!=="undefined"){n=s.selectionStart;r=s.selectionEnd;selection=s.value.substring(n,r);t=t+selection+"</a>";i=n+t.length;if(n==r)i-="</a>".length;s.value=s.value.substring(0,n)+t+s.value.substring(r,s.value.length);s.selectionStart=s.selectionEnd=i}wpLink.close();s.focus()},mceUpdate:function(){var t=tinyMCEPopup.editor,n=wpLink.getAttrs(),r,i;tinyMCEPopup.restoreSelection();r=t.dom.getParent(t.selection.getNode(),"A");if(!n.href||n.href=="http://"){if(r){tinyMCEPopup.execCommand("mceBeginUndoLevel");i=t.selection.getBookmark();t.dom.remove(r,1);t.selection.moveToBookmark(i);tinyMCEPopup.execCommand("mceEndUndoLevel");wpLink.close()}return}tinyMCEPopup.execCommand("mceBeginUndoLevel");if(r==null){t.getDoc().execCommand("unlink",false,null);tinyMCEPopup.execCommand("mceInsertLink",false,"#mce_temp_url#",{skip_undo:1});tinymce.each(t.dom.select("a"),function(e){if(t.dom.getAttrib(e,"href")=="#mce_temp_url#"){r=e;t.dom.setAttribs(r,n)}});if(e(r).text()=="#mce_temp_url#"){t.dom.remove(r);r=null}}else{t.dom.setAttribs(r,n)}if(r&&(r.childNodes.length!=1||r.firstChild.nodeName!="IMG")){t.focus();t.selection.select(r);t.selection.collapse(0);tinyMCEPopup.storeSelection()}tinyMCEPopup.execCommand("mceEndUndoLevel");wpLink.close()},updateFields:function(e,n,r){t.url.val(n.children(".item-permalink").val());t.title.val(n.hasClass("no-title")?"":n.children(".item-title").text());if(r&&r.type=="click")t.url.focus()},setDefaultValues:function(){t.url.val("http://");t.title.val("");t.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var t=e(this),r,i=t.val();if(i.length>2){n.recent.hide();n.search.show();if(wpLink.lastSearch==i)return;wpLink.lastSearch=i;r=t.parent().find(".spinner").show();n.search.change(i);n.search.ajax(function(){r.hide()})}else{n.search.hide();n.recent.show()}},next:function(){n.search.next();n.recent.next()},prev:function(){n.search.prev();n.recent.prev()},keydown:function(t){var n,r=e.ui.keyCode;switch(t.which){case r.UP:n="prev";case r.DOWN:n=n||"next";clearInterval(wpLink.keyInterval);wpLink[n]();wpLink.keyInterval=setInterval(wpLink[n],wpLink.keySensitivity);break;default:return}t.preventDefault()},keyup:function(t){var n=e.ui.keyCode;switch(t.which){case n.ESCAPE:t.stopImmediatePropagation();if(!e(document).triggerHandler("wp_CloseOnEscape",[{event:t,what:"wplink",cb:wpLink.close}]))wpLink.close();return false;break;case n.UP:case n.DOWN:clearInterval(wpLink.keyInterval);break;default:return}t.preventDefault()},delayedCallback:function(e,t){var n,r,i,s;if(!t)return e;setTimeout(function(){if(r)return e.apply(s,i);n=true},t);return function(){if(n)return e.apply(this,arguments);i=arguments;s=this;r=true}},toggleInternalLinking:function(n){var r=e("#search-panel"),i=t.dialog.wpdialog("widget"),s=!r.is(":visible"),o=e(window);e(this).toggleClass("toggle-arrow-active",s);t.dialog.height("auto");r.slideToggle(300,function(){setUserSetting("wplink",s?"1":"0");t[s?"search":"url"].focus();var e=o.scrollTop(),n=i.offset().top,r=n+i.outerHeight(),u=r-o.height();if(u>e){i.animate({top:u<n?n-u:e},200)}});n.preventDefault()}};i=function(t,n){var r=this;this.element=t;this.ul=t.children("ul");this.waiting=t.find(".river-waiting");this.change(n);this.refresh();t.scroll(function(){r.maybeLoad()});t.delegate("li","click",function(t){r.select(e(this),t)})};e.extend(i.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(e,t){var n,r,i,s;if(e.hasClass("unselectable")||e==this.selected)return;this.deselect();this.selected=e.addClass("selected");n=e.outerHeight();r=this.element.height();i=e.position().top;s=this.element.scrollTop();if(i<0)this.element.scrollTop(s+i);else if(i+n>r)this.element.scrollTop(s+i-r+n);this.element.trigger("river-select",[e,t,this])},deselect:function(){if(this.selected)this.selected.removeClass("selected");this.selected=false},prev:function(){if(!this.visible)return;var e;if(this.selected){e=this.selected.prev("li");if(e.length)this.select(e)}},next:function(){if(!this.visible)return;var t=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);if(t.length)this.select(t)},ajax:function(e){var t=this,n=this.query.page==1?0:wpLink.minRiverAJAXDuration,r=wpLink.delayedCallback(function(n,r){t.process(n,r);if(e)e(n,r)},n);this.query.ajax(r)},change:function(e){if(this.query&&this._search==e)return;this._search=e;this.query=new s(e);this.element.scrollTop(0)},process:function(t,n){var r="",i=true,s="",o=n.page==1;if(!t){if(o){r+='<li class="unselectable"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>"}}else{e.each(t,function(){s=i?"alternate":"";s+=this["title"]?"":" no-title";r+=s?'<li class="'+s+'">':"<li>";r+='<input type="hidden" class="item-permalink" value="'+this["permalink"]+'" />';r+='<span class="item-title">';r+=this["title"]?this["title"]:wpLinkL10n.noTitle;r+='</span><span class="item-info">'+this["info"]+"</span></li>";i=!i})}this.ul[o?"html":"append"](r)},maybeLoad:function(){var e=this,t=this.element,n=t.scrollTop()+t.height();if(!this.query.ready()||n<this.ul.height()-wpLink.riverBottomThreshold)return;setTimeout(function(){var n=t.scrollTop(),r=n+t.height();if(!e.query.ready()||r<e.ul.height()-wpLink.riverBottomThreshold)return;e.waiting.show();t.scrollTop(n+e.waiting.outerHeight());e.ajax(function(){e.waiting.hide()})},wpLink.timeToTriggerRiver)}});s=function(e){this.page=1;this.allLoaded=false;this.querying=false;this.search=e};e.extend(s.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(n){var r=this,i={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:t.nonce.val()};if(this.search)i.search=this.search;this.querying=true;e.post(ajaxurl,i,function(e){r.page++;r.querying=false;r.allLoaded=!e;n(e,i)},"json")}});e(document).ready(wpLink.append);e(document).ready(wpLink.init)})(jQuery)